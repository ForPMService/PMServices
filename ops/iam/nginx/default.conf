# ═══════════════════════════════════════════════════════════════
# Edge (Nginx) — единственная публичная точка входа
# ИНВАРИАНТ: Keycloak НЕ проксируется из Edge (ADR 4.7, UX-ADR-001)
# Все KC-маршруты будут через BFF proxy (Фаза 3)
# ═══════════════════════════════════════════════════════════════

# ── Security headers (добавляются ко всем ответам) ──
map $uri $csp_header {
    default "default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self'; connect-src 'self'; frame-ancestors 'none'; base-uri 'self'; form-action 'self'; require-trusted-types-for 'script'";
}

server {
    listen 80;
    server_tokens off;

    # ── Global security headers ──
    add_header X-Frame-Options         "DENY"                                always;
    add_header X-Content-Type-Options  "nosniff"                             always;
    add_header Referrer-Policy         "strict-origin-when-cross-origin"     always;
    add_header Permissions-Policy      "camera=(), microphone=(), geolocation=()" always;
    add_header Content-Security-Policy $csp_header                           always;

    # ── Sane defaults ──
    client_max_body_size    2m;
    proxy_read_timeout      30s;
    proxy_connect_timeout   5s;
    proxy_send_timeout      15s;

    # ── Общие proxy headers ──
    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Host  $host;

    # ══════════════════════════════════════
    # Явные запреты (жёсткие инварианты)
    # ══════════════════════════════════════

    # Keycloak admin console — всегда 403
    location /admin/ {
        return 403;
    }

    # Token endpoint — никогда не отдаём наружу (server-to-server only)
    location ~ ^/realms/[^/]+/protocol/openid-connect/token$ {
        return 403;
    }

    # ══════════════════════════════════════
    # Edge root — быстрая проверка доступности
    # ══════════════════════════════════════

    location = / {
        add_header Content-Type text/plain;
        return 200 "edge ok\n";
    }

    # ══════════════════════════════════════
    # Явные маршруты через BFF
    # ══════════════════════════════════════

    # Invite link — явный location для будущего rate limiting
    location /invite {
        proxy_pass http://bff:8080;
    }

    # ══════════════════════════════════════
    # Catch-all → BFF (единственная публичная точка)
    # /health, /auth/*, /api/* — всё идёт сюда
    # ══════════════════════════════════════

    location / {
        proxy_pass http://bff:8080;
    }
}
